<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    :root {
      --bg-color: #F3E9DC;
      --accent-color: #C08552;
      --primary-color: #5E3023;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      padding: 15px;
      color: var(--primary-color);
    }

    .main-container {
      max-width: 800px;
      margin: auto;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      background: var(--primary-color);
      color: white;
      border-radius: 0;
      text-align: center;
    }

    .rules-container {
      background: #fff;
      border-left: 5px solid var(--accent-color);
      padding: 15px;
      font-size: 0.9rem;
    }

    .rules-container ul {
      padding-left: 20px;
      margin-bottom: 0;
    }

    .rules-container li {
      margin-bottom: 8px;
    }

    .btn-primary {
      background: var(--accent-color);
      border: none;
      padding: 12px;
      font-weight: 600;
      width: 100%;
      border-radius: 10px;
    }

    .btn-primary:hover {
      background: var(--primary-color);
    }

    #calendar {
      background: white;
      padding: 10px;
    }

    .fc .fc-button-primary {
      background-color: var(--accent-color) !important;
      border-color: var(--accent-color) !important;
      color: white !important;
      text-transform: capitalize;
    }

    .fc .fc-button-primary:hover {
      background-color: var(--primary-color) !important;
    }

    .fc .fc-toolbar-title {
      color: var(--primary-color) !important;
      font-weight: bold;
    }

    .wa-link {
      color: black;
    }
  </style>
</head>

<body>

  <div class="main-container">
    <div class="card">
      <div class="card-header p-3">
        <h5 class="mb-0">üìÖ Jadwal Peminjaman</h5>
      </div>
      <div id="calendar"></div>
    </div>

    <div class="card">
      <div class="card-header p-3">
        <h5 class="mb-0">üìú Aturan Peminjaman</h5>
      </div>
      <div class="card-body rules-container">
        <ul>
          <li>Setiap peminjam cukup menuliskan <strong>nama kelompok</strong> saja (contoh : 86).</li>
          <li>Konfirmasi dan pengambilan proyektor dilakukan melalui CP a/n. Putri di Pondokan Kelompok 86, dengan
            menyerahkan <strong>KTM</strong> sebagai jaminan</li>
          <li>Toleransi keterlambatan pengembalian <strong>maksimal 30 menit</strong> . Jika melebihi, peminjam wajib
            mengantarkan ke kelompok berikutnya.</li>
          <li>Kerusakan atau kehilangan menjadi <strong>tanggung jawab peminjam</strong>.</li>
          <li>Jika terjadi benturan jadwal, akan dikonfirmasi oleh CP Kelompok 86.</li>
          <li>Jika terjadi <strong>perubahan jadwal</strong> , silahkan mengkonfirmasi juga melalui CP dibawah ini.
          </li>
          <a href="https://wa.me/6285770652269" target="_blank" class="wa-link">CP:
            <strong>+62 857-7065-2269 (Putri)</strong>
          </a>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="card-header p-3">
        <h5 class="mb-0">Form Booking Proyektor</h5>
      </div>
      <div class="card-body p-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Nama / Kelompok</label>
            <input type="text" id="nama" class="form-control" placeholder="Nama peminjam">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Tanggal Pinjam</label>
            <input type="date" id="tanggal" class="form-control">
          </div>
        </div>
        <div class="mb-4">
          <label class="form-label fw-bold">Pilih Jam</label>
          <select id="waktu" class="form-select">
            <option value="" disabled selected>-- Pilih Jam --</option>
            <option value="07.00 - 10.00">üåÖ Pagi (07.00 - 10.00)</option>
            <option value="11.00 - 14.00">‚òÄÔ∏è Siang (11.00 - 14.00)</option>
            <option value="15.00 - 18.00">üåá Sore (15.00 - 18.00)</option>
            <option value="19.00 - 21.00">üåô Malam (19.00 - 21.00)</option>
          </select>
        </div>

        <div class="form-check mb-4">
          <input class="form-check-input" type="checkbox" id="checkAturan">
          <label class="form-check-label small" for="checkAturan">
            Saya telah membaca dan menyetujui aturan peminjaman di atas.
          </label>
        </div>

        <button id="btnPesan" onclick="kirim()" class="btn btn-primary">Konfirmasi Booking</button>
      </div>
    </div>
  </div>

  <script>
    let calendar;
    let slotTerpakai = {}; 
    let masterJam = []; 

    document.addEventListener('DOMContentLoaded', function() {
      const selectWaktu = document.getElementById('waktu');
      masterJam = Array.from(selectWaktu.options).map(o => ({ value: o.value, text: o.text }));

      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        locale: 'id',
        dateClick: function(info) {
          document.getElementById('tanggal').value = info.dateStr;
          updateDropdown(info.dateStr);
        },
        events: function(info, success) {
          google.script.run.withSuccessHandler(success).ambilJadwal();
        }
      });
      calendar.render();
      updateDataTerpakai();
    });

    function updateDataTerpakai() {
      google.script.run.withSuccessHandler(function(data) {
        slotTerpakai = data;
        const currentTgl = document.getElementById('tanggal').value;
        if (currentTgl) updateDropdown(currentTgl);
      }).ambilSlotTerpakai();
    }

    function updateDropdown(tanggalPilihan) {
      const select = document.getElementById('waktu');
      const jamTerpakai = slotTerpakai[tanggalPilihan] || [];
      select.innerHTML = ''; 

      masterJam.forEach(jam => {
        const opt = document.createElement('option');
        opt.value = jam.value;
        opt.text = jam.text;

        if (jam.value === "") {
          opt.disabled = true;
          opt.selected = true;
        } else if (jamTerpakai.includes(jam.value)) {
          opt.disabled = true;
          opt.text = jam.text + " ‚ùå (Sudah Dipesan)";
        }
        select.add(opt);
      });
    }

    document.getElementById('tanggal').addEventListener('change', function() {
      updateDropdown(this.value);
    });

    function kirim() {
      const btn = document.getElementById('btnPesan');
      const isChecked = document.getElementById('checkAturan').checked;
      const data = {
        nama: document.getElementById('nama').value,
        tanggal: document.getElementById('tanggal').value,
        waktu: document.getElementById('waktu').value
      };

      if (!data.nama || !data.tanggal || !data.waktu) {
        alert("Lengkapi semua data!"); return;
      }
      
      if (!isChecked) {
        alert("Harap centang persetujuan aturan peminjaman!"); return;
      }

      btn.disabled = true;
      btn.innerText = "‚è≥ Menyimpan...";

      google.script.run.withSuccessHandler(function(res) {
        alert(res);
        btn.disabled = false;
        btn.innerText = "Konfirmasi Booking";
        if (res.includes("BERHASIL")) {
          document.getElementById('nama').value = '';
          document.getElementById('checkAturan').checked = false;
          updateDataTerpakai();
          calendar.refetchEvents();
        }
      }).simpanData(data);
    }
  </script>
</body>

</html>
